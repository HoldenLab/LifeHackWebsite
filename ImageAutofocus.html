<!DOCTYPE html>
<html>
<head>
  <title>LifeHack Microscope: ImLock Autofocus/Stabilisation</title>
  <meta name="description" content="An infra-red brighfield image based autofocus and lateral drift correction device. Capable of maintaining lock upto 50 microns away from the cover-slip">
  <meta name="author" content="Josh Edwards">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="main.css">

  <link rel="stylesheet" type="text/css" href="menu.css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B9XZF5GEV3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B9XZF5GEV3');
</script>

</head>

<body>

    <div id="myNav" class="overlay">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <div class="grid-container">
        <a href="home.html"><div class="hero-image-home">
          <div class="menu-text"><h1>Home</h1></div>
        </div></a>
        <a href="MainBody.html"><div class="hero-image-MainBody">
          <div class="menu-text"><h1>Main Body</h1></div>
        </div></a>
        <a href="BeamExpansion.html"><div class="hero-image-BeamExpansion">
          <div class="menu-text"><h1>Beam Expansion Module</h1></div>
        </div></a>
        <a href="Excitation.html"><div class="hero-image-Excitation">
          <div class="menu-text"><h1>Excitation Module</h1></div>
        </div></a>
        <a href="FocusShifter.html"><div class="hero-image-FocusShifter">
          <div class="menu-text"><h1>Focus Shifter</h1></div>
        </div></a>
        <a href="IncubationBox.html"><div class="hero-image-IncubationBox">
          <div class="menu-text"><h1>Incubation Box</h1></div>
        </div></a>
        <a href="https://github.com/HoldenLab/LifeHack"><div class="hero-image-github">
          <div class="menu-text"><h1>Git Hub</h1></div>
        </div></a>
       <a href="ImageAutofocus.html"><div class="hero-image-ImageAutofocus">
          <div class="menu-text"><h1>ImLock</h1></div>
        </div></a>
        <a href="Operation.html"><div class="hero-image-Operation">
          <div class="menu-text"><h1>Operation</h1></div>
        </div></a>
      </div>
    </div>
  <script>
  function openNav() {
    document.getElementById("myNav").style.height = "100%";
  }
  
  function closeNav() {
    document.getElementById("myNav").style.height = "0px";
  }
  </script>
  
  <div class="hero-image">
    <div class="hero-text">
      <h1>ImLock</h1>
      <p>Infra-Red Image Based Deep Autofocus and Live Drift Correction</p>
    </div>
  </div>

  <div class="nav-wrapper" style="height:80px;">
    <div id="navbar">
      <a href="javascript:void(0)" onclick="openNav()">&#9776; Menu</a>
    </div>
  </div>
  
  <div class="sidenav">
    <a href="#Description">Description</a>
    <a href="#Parts">Parts</a>
    <a href="#Construction">Construction</a>
    <a href="#Software">Software</a>
    <a href="https://github.com/HoldenLab/LifeHack/tree/master/Image%20Autofocus">Go to GitHub</a>
    <a href="https://github.com/HoldenLab/LifeHack/issues">Report Bug/Feedback</a>
    <hr> 
    <p>Project Contributors: Josh Edwards, Kevin Whitley, Sudeer Peneti, Yann Cesbron, Seamus Holden</p>
    <p>Website by Josh Edwards</p>
    <p>Updated: April 2023</p>
  </div>

  <div class="page">
    <video src="Video/ir-image-autofocus-animation.mp4" width="90%" controls autoplay muted></video>
  
    <h1 id="Description">Description</h1><hr>

    <p>This module provides the capability for infra-red brightfield imaging concurrently with visible band fluorescence. This hardware is combined with custom software to conduct image based, deep autofocus at up to 50 microns in depth. We have found this especially useful in imaging samples set in PDMS-microholes (used in Whitley et al Nat Commun 2021) where the cells themselves are held away from the cover surface.</p>

    <img src="Images/Image-Autofocus.jpg" width="60%">

    <h1 id="Parts">Parts</h1><hr>

    <iframe src="Parts-List/ImageAutofocus-Parts.htm" width="100%" height="500px" title="Parts"></iframe>

    <div class="minipage">
      <a class="button-design" href="Parts-List/ImageAutofocus-Parts.xlsx">&#8681; Download &#8681;</a>
      <a class="button-design" href="https://github.com/HoldenLab/LifeHack/tree/master/Image%20Autofocus/Parts">&#8681; Get Custom Part Designs &#8681;</a>
    </div>

    <p>If you are adding this to an existing system it can be simpler to add hardware after the camera port. If this is the case we recomend using a <a href="https://www.cairn-research.co.uk/product/twincam">TwinCam</a> to give a second pathway for the IR camera.</p>

    <h1 id="Construction">Construction</h1><hr>

    <a class="button-design" href="https://a360.co/3p8be5k" target="_blank">&#x1f441; View CAD Design Online &#x1f441;</a>
  
    <p>As this module has only one pathway and few degrees of freedom for adjustment it can be constructed and attached to the system simply following the designs. The combiner cube is the only part that needs alignment and this is detailed in the <a href="MainBody.html#Construction">Main Body</a> module.</p>

    <p>To add the ImLock to an existing microscope system we recomend adding the second camera after the camera port for simplicity. This can be done easily using products such as CAIRN's <a href="https://www.cairn-research.co.uk/product/twincam/">TwinCam</a>.</p>

    <p>In principle this sytem can operate at a range of wavelengths. However, the suggested camera suffers from reduced sensitivity into the IR range. As such, poor performance has been observed when operating this system at 1050nm due to low SNR. To achieve a sufficient SNR whilst avoiding clashes with the CRISP system operating at 940nm we recomend operating with 850nm illumination.</p>

    <img src="Images/IMX250_sensitivity.jpg" width="40%">

    <h1 id="Software">Software</h1><hr>

    <p>This is a MicroManager hardware autofocus plugin developed between the Henriques and Holden laboratories. This plugin will perform microscopy autofocus and lateral drift correction using the cross correlated signal from infrared brightfield microscopy. It is based on the principle described in McGorty et al, Optical Nanoscopy 2013. As such, this software is not coupled to any particular hardware and may be used with cameras and stages other than those described here.</p>

    <p>The original version of the plugin works within a single instance of micromanager. However, when using this with cameras other than the Blackfly camera in the parts-list we frequently see issues. A second version is available that will run in a separate instance of micromanager to the data aquisition which avoids these problems. This version also works with the Blackfly camera so use whichever suits you best.</p>

    <h2>Instructions: Please select a version</h2>

    <div class="tab">
      <button class="tablinks" onclick="openVersion(event, 'Main')">Main</button>
      <button class="tablinks" onclick="openVersion(event, 'Single-Core')">Single Core</button>
    </div>
    
    <!-- Tab content -->
    <div id="Main" class="tabcontent">

      <p>This is the primary version of ImLock. It is designed to work within a single instance of micromanager alongside data collection. Testing with a few cameras has yielded mixed results so if this fails with your camera please try the other version.</p>

      <h3>Installation</h3>

      <a class="button-design" href="https://github.com/HoldenLab/DeepAutoFocus">&#x1f441; Get Software from GitHub &#x1f441;</a>
  
      <p>From the folder "dist" in the GitHub repository, copy "ImLock.jar" and the content of the "lib" folder into the Micromanager "plugins/micro-manager" directory. In the case of these files already existing in the target directory, the target directory files should be retained.</p>
  
      <p>The camera used for this module must be added to a MicroManager config file separate from the main system config file. Instructions are available <a href="https://micro-manager.org/wiki/Spinnaker">here</a> to install the correct drivers for the Blackfly camera.</p>
  
      <p>The plugin may now be launched in MicroManager from "plugins/Beta/ImLock". On opening the <a href="https://github.com/HoldenLab/LifeHack/blob/master/Operation/BlackflyCamera.cfg">Config file</a> containing the camera's device adapter should be loaded using the "select configuration file" and "load hardware" buttons under the configuration tab (This will happen automatically on subsequent openings).</p>
  
      <h3>Use</h3>
  
      <p>The plugin does not have the ability to trigger the illumination LED so this must be controlled manually. If using this as part of the LifeHack system this can be done through MicroManager. Our testing has been conducted with the Tiger Controller's MAINTAIN(MA) setting set to "3 - Motors on during wait time".</p>
    
      <img src="Images/ImLock_JE_CAIRN.png" width="100%">
    
      <p>To use the plugin, First "get background image" to perform background subtraction. The stage will scan around the sample to record multiple fields of view for averaging.</p>
      <p>Next "calibrate pixel size" to calculate the pixels-to-nm conversion factor and axis orientations. The stage will move laterally in user-defined steps and calculate the pixel displacements by cross-correlation.</p>
      <p>"Start" takes a reference z-stack (if using XYZ or Z correction) or a single reference image (if using XY correction) and begins the drift correction protocol selected using the pulldown menu.</p>
      <p>The tick-box options on the control panel are mostly self explanitory. "Show drift plots" produces plots of the live position reading to aid with setting gains(described in "Variables").</p>
      <p>If "Save drift data to file" is ticked, positions will be saved in a columnwise ".csv" file with columns "time, x, y, z".</p>
    
      <h3>Variables</h3>
      <h4>Configuration Tab</h4>
      <ul>
        <li><b>Background subtraction step size:</b> Lateral move between background subtraction images. We find that a step size of 50 um works well.</li>
        <li><b>Calibration step size:</b> Lateral move between images during the pixels-to-nm calibration routine. We find that a step size of 1-5 um works well.</li>
        <li><b>Exposure time:</b> Exposure time of the camera, should be balanced to minimise LED power and motion blur.</li>
        <li><b>Maximum ROI to analyse:</b> Sets the size of the area to perform cross-correlation on. The limits of this are camera-dependent. Larger fields of view will require more processing time but use more of the sample to lock on to.</li>
        <li><b>Pixels to trim from edges:</b> Removes edge pixels from cross-correlation calculations. Can be used to speed up processing if the camera has a minumum ROI limit.</li>
        <li><b>Step size for Z correction:</b> Sets the depth between the images of the reference z-stack taken at the beginning of a run.</li>
        <li><b>Zp (Axial proportional gain):</b> Proportional gain sets the strength of correction relative to the position error. higher values will cause faster responses but can lead to overcorrections. A value of 1 is a good starting point</li>
        <li><b>Zi (Axial integral gain):</b> Integral gain used to correct for a stable offset from the zero position. Can induce oscillations if too strong. Often this value can be left at 0</li>
        <li><b>Lp (Lateral proportional gain):</b> Proportional gain sets the strength of correction relative to the position error. higher values will cause faster responses but can lead to overcorrections. A value of 1 is a good starting point</li>
        <li><b>Li (Lateral integral gain):</b> Integral gain used to correct for a stable offset from the zero position. Can induce oscillations if too strong. Often this value can be left at 0</li>
        <li><b>Time between corrections:</b> Sets the dwell time between stage corrections to avoid high frequency corrections to noise. Must be set greater than the set exposure time.</li>
        <li><b>Time between reference updates:</b> Sets the time between updates to the reference stack. Useful if your sample changes significantly over time. Setting to 0 turns this feature off.</li>
        <li><b>Maximum translation:</b> Limit on shift to prevent stage crashing.</li>
      </ul>
      <h4>Advanced Tab</h4>
      <ul>
        <li><b>Lateral Gain Bias:</b> Bias of gain between X and Y axies. Positive values bias towards X and negative towards Y. Should not be needed for most systems.</li>
        <li><b>Axial Dead Zone (nm):</b> Minimum move command that will be sent to the Z stage. Any smaller corrections will be ignored. Useful for stages with poor encoder resolution (usually not needed for piezo stages). Set to the same as the encoder resolution if you see odd behaviour when set to 0.</li>
        <li><b>Lateral Dead Zone (nm):</b> Minimum move command that will be sent to the XY stage. Any smaller corrections will be ignored. Useful for stages with poor encoder resolution. Set to the same as the encoder resolution if you see odd behaviour when set to 0.</li>
      </ul>
    </div>
    
    <div id="Single-Core" class="tabcontent">
      <p>This is a secondary version designed to work robustly with any camera normally supported by Micro-Manager. It is designed to work within a second instance of Micro-Manager seperate to data collection. Working in separate Micro-Manager instances means some features require additional hardware so try the other version first.</p>
      
      <h3>Installation</h3>

      <a class="button-design" href="https://github.com/HoldenLab/DeepAutoFocus/tree/JE-SingleCore">&#x1f441; Get Software from GitHub &#x1f441;</a>
  
      <p>From the folder "dist" in the GitHub repository, copy "ImLock.jar" and the content of the "lib" folder into the Micromanager "plugins/micro-manager" directory. In the case of these files already existing in the target directory, the target directory files should be retained.</p>
  
      <p>The camera and stages used must be added to a MicroManager config file. Use this config file when launching Micro-Manager.</p>
  
      <p>The plugin may now be launched in MicroManager from "plugins/Beta/ImLock". On opening the plugin will use the configuration already loaded by micromanager.</p>
  
      <h3>Use</h3>
  
      <p>The plugin does not have the ability to trigger the illumination LED so this must be controlled manually. If using this as part of the LifeHack system this can be done through MicroManager. Our testing has been conducted with the Tiger Controller's MAINTAIN(MA) setting set to "3 - Motors on during wait time".</p>
    
      <img src="Images/ImLock_SingleCore.png" width="100%">
    
      <p>To use the plugin, First "get background image" to perform background subtraction. The stage will scan around the sample to record multiple fields of view for averaging.</p>
      <p>Next "calibrate pixel size" to calculate the pixels-to-nm conversion factor and axis orientations. The stage will move laterally in user-defined steps and calculate the pixel displacements by cross-correlation.</p>
      <p>"Start" takes a reference z-stack (if using XYZ or Z correction) or a single reference image (if using XY correction) and begins the drift correction protocol selected using the pulldown menu.</p>
      <p>The tick-box options on the control panel are mostly self explanitory. "Show drift plots" produces plots of the live position reading to aid with setting gains(described in "Variables").</p>
      <p>If "Save drift data to file" is ticked, positions will be saved in a columnwise ".csv" file with columns "time, x, y, z".</p>
    
      <h3>Variables</h3>
      <h4>Configuration Tab</h4>
      <ul>
        <li><b>Background subtraction step size:</b> Lateral move between background subtraction images. We find that a step size of 50 um works well.</li>
        <li><b>Calibration step size:</b> Lateral move between images during the pixels-to-nm calibration routine. We find that a step size of 1-5 um works well.</li>
        <li><b>Exposure time:</b> Exposure time of the camera, should be balanced to minimise LED power and motion blur.</li>
        <li><b>Maximum ROI to analyse:</b> Sets the size of the area to perform cross-correlation on. The limits of this are camera-dependent. Larger fields of view will require more processing time but use more of the sample to lock on to.</li>
        <li><b>Pixels to trim from edges:</b> Removes edge pixels from cross-correlation calculations. Can be used to speed up processing if the camera has a minumum ROI limit.</li>
        <li><b>Step size for Z correction:</b> Sets the depth between the images of the reference z-stack taken at the beginning of a run.</li>
        <li><b>Zp (Axial proportional gain):</b> Proportional gain sets the strength of correction relative to the position error. higher values will cause faster responses but can lead to overcorrections. A value of 1 is a good starting point</li>
        <li><b>Zi (Axial integral gain):</b> Integral gain used to correct for a stable offset from the zero position. Can induce oscillations if too strong. Often this value can be left at 0</li>
        <li><b>Lp (Lateral proportional gain):</b> Proportional gain sets the strength of correction relative to the position error. higher values will cause faster responses but can lead to overcorrections. A value of 1 is a good starting point</li>
        <li><b>Li (Lateral integral gain):</b> Integral gain used to correct for a stable offset from the zero position. Can induce oscillations if too strong. Often this value can be left at 0</li>
        <li><b>Time between corrections:</b> Sets the dwell time between stage corrections to avoid high frequency corrections to noise. Must be set greater than the set exposure time.</li>
        <li><b>Time between reference updates:</b> Sets the time between updates to the reference stack. Useful if your sample changes significantly over time. Setting to 0 turns this feature off.</li>
        <li><b>Maximum translation:</b> Limit on shift to prevent stage crashing.</li>
      </ul>
      <h4>Advanced Tab</h4>
      <ul>
        <li><b>Lateral Gain Bias:</b> Bias of gain between X and Y axies. Positive values bias towards X and negative towards Y. Should not be needed for most systems.</li>
        <li><b>Axial Dead Zone (nm):</b> Minimum move command that will be sent to the Z stage. Any smaller corrections will be ignored. Useful for stages with poor encoder resolution (usually not needed for piezo stages). Set to the same as the encoder resolution if you see odd behaviour when set to 0.</li>
        <li><b>Lateral Dead Zone (nm):</b> Minimum move command that will be sent to the XY stage. Any smaller corrections will be ignored. Useful for stages with poor encoder resolution. Set to the same as the encoder resolution if you see odd behaviour when set to 0.</li>
      </ul>

      <h3>Multi-Dimensional Acquisitions (Optional)</h3>

      <p>To perform imaging across multiple fields of view and or Z-stacks while using this version of ImLock, add an Arduino uno to the Micro-Manager config file. This will need to be set up as an "Arduino-Input" device.</p>
  
      <p>Upon opening the ImLock plugin go to the configuration panel and select the Arduino using the "Trigger" pulldown. The plugin is now set up to recieve external interupt commands via the Arduino.</p>
  
      <p>If using Micro-Manager for data collection you will need to add a second arduino to the config file for the data collection instance of Micro-Manager. This will need to be set up as an "Arduino-Shutter" device with the output wired as below. Within Micromanager set this up as a Multi-shutter device with your acquisition shutter so that the two are triggered together. Connect this Arduino to the first Arduino as its input and the two instances of micromanager will be able to talk to eachother.</p>
  
      <img src="Images/ImLock_Arduino.png" width="50%">
      
      <p>If you are using other software you will need your own way of providing the interupt signals to the input Arduino, <a href=https://www.cairn-research.co.uk>cairn-research</a> may be able to help with this.</p>
    </div> 
  </div>

  <div class="bottomnav">
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">License: Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    <a href="https://blogs.ncl.ac.uk/holdenlab/">Holden Lab Website</a>
  </div>

  <script>
    window.onscroll = function() {myFunction()};
    
    var navbar = document.getElementById("navbar");
    var sticky = navbar.offsetTop;
    
    function myFunction() {
      if (window.pageYOffset >= sticky) {
        navbar.classList.add("sticky")
      } else {
        navbar.classList.remove("sticky");
      }
    }

    function openVersion(evt, cityName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    document.getElementById("defaultOpen").click();
    </script>

  </body>
  </html>